apiVersion: apps/v1
kind: Deployment
metadata:
  name: altcha
  labels:
    app: altcha
spec:
  replicas: 1
  selector:
    matchLabels:
      app: altcha
  template:
    metadata:
      labels:
        app: altcha
    spec:
      initContainers:
      - name: geoip-download
        image: alpine:3.21
        command: ["/bin/sh", "-c"]
        args:
        - |
          if [ -z "$GEOIP_LICENSE_KEY" ]; then
            echo "[GEOIP] GEOIP_LICENSE_KEY not set, skipping download"
            exit 0
          fi
          URL="https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=${GEOIP_LICENSE_KEY}&suffix=tar.gz"
          echo "[GEOIP] Downloading GeoLite2-Country..."
          wget -q -O /tmp/geoip.tar.gz "$URL"
          if [ $? -ne 0 ]; then
            echo "[GEOIP] WARNING: download failed, continuing without GeoIP"
            exit 0
          fi
          tar -xzf /tmp/geoip.tar.gz -C /tmp
          cp /tmp/GeoLite2-Country_*/GeoLite2-Country.mmdb /geoip/GeoLite2-Country.mmdb
          if [ $? -eq 0 ]; then
            echo "[GEOIP] GeoLite2-Country.mmdb ready"
          else
            echo "[GEOIP] WARNING: extraction failed, continuing without GeoIP"
          fi
        env:
        - name: GEOIP_LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: altcha-secret
              key: GEOIP_LICENSE_KEY
              optional: true
        volumeMounts:
        - name: geoip
          mountPath: /geoip
      containers:
      - name: altcha
        image: docker.io/rayshoo/altcha:latest
        ports:
        - name: http
          containerPort: 3000
          protocol: TCP
        - name: demo
          containerPort: 8000
          protocol: TCP
        envFrom:
        - secretRef:
            name: altcha-secret
        env:
        - name: GEOIP_DB
          value: /geoip/GeoLite2-Country.mmdb
        livenessProbe:
          httpGet:
            path: /health/live
            port: http
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health/ready
            port: http
          initialDelaySeconds: 3
          periodSeconds: 5
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
        volumeMounts:
        - name: geoip
          mountPath: /geoip
          readOnly: true
      volumes:
      - name: geoip
        emptyDir: {}
